{#
/**
 * @file
 * Default theme implementation to present an audit question entity.
 *
 * This template is used when viewing a canonical audit question page,
 *
 * Available variables:
 * - content: A list of content items. Use 'content' to print all content, or
 *   print a subset such as 'content.label'.
 * - attributes: HTML attributes for the container element.
 * - question: The question text.
 * - help_text: Help text for the question.
 * - audit_entity: The audit node entity.
 * - audit_question_entity: The audit question entity.
 * - evidences: Array of existing evidence entities for this question.
 *
 * @see template_preprocess_audit_question()
 */
#}
<article{{ attributes }}>
  {% if view_mode != 'full' %}
    {{ title_prefix }}
    {{ title_suffix }}
  {% endif %}
  {% if content and not view_mode == 'audit' %}
    {{- content -}}
  {% endif %}
</article>

{% if(view_mode == 'audit') %}
  <div class="audit-card" style="margin-left: {{ question_hierarchy_level * 30 }}px;">
    <div class="audit-card-header">
      <h3 class="audit-card-title" style="display: flex; align-items: center;">
        {% if is_child_question %}
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-layout-sidebar-inset" viewBox="0 0 16 16" style="margin-right: 5px; flex-shrink: 0;">
            <path d="M14 2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1zM2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2z"/>
            <path d="M3 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1z"/>
          </svg>
        {% endif %}
        <span style="flex: 1;">{{ question }}</span>
        {% if help_text %}
          <span class="audit-help-icon" data-audit-tooltip="{{ help_text }}" style="margin-left: auto;">
            <i class="bi bi-info-circle-fill"></i>
          </span>
        {% endif %}
      </h3>
    </div>
    <div class="audit-card-body">
      <div class="audit-card-content">
        {# Display existing evidences for all question types #}
        {% if evidences is not empty %}
          <div class="audit-evidences">
            {% for evidence in evidences %}
              <div class="audit-evidence-item">
                <div class="audit-evidence-content">{{ evidence.field_evidence.value|length > 140 ? (evidence.field_evidence.value|slice(0, 360) ~ '...') : evidence.field_evidence.value }}</div>

                {# files list here #}
                {% if evidence.field_supporting_files is not empty %}
                  <div class="audit-evidence-files">
                    <strong>{{ 'Supporting Files:'|t }}</strong>
                    <ul>
                      {% for file_item in evidence.field_supporting_files %}
                        {% set file = file_item.entity %}
                        {% if file %}
                          <li class="audit-file-item">
                            <a href="{{ file_url(file.uri.value) }}" target="_blank">
                              <i class="bi bi-file-earmark"></i>
                              {{ file.getFilename() }}
                            </a>
                            <small class="text-muted">({{ (file.getSize() / 1024 / 1024)|number_format(2) }} MB)</small>
                          </li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                <div class="audit-evidence-actions">
                  {# Evaluate with AI #}
                  {# <a href="#" title="Evaluate with AI"><i class="bi bi-stars"></i></a> #}
                  <span>&nbsp;</span>
                  {# Edit button #}
                  {% if audit_entity and audit_question_entity %}
                    <a title="Edit evidence" href="{{ path('audit.evidence.edit_form', {'audit': audit_entity.id(), 'audit_question': audit_question_entity.id(), 'audit_evidence': evidence.id()}) }}" class="audit-evidence-edit"><i class="bi bi-pencil-square"></i></a>
                  {% else %}
                    <button class="audit-evidence-edit" data-evidence-id="{{ evidence.id() }}"><i class="bi bi-pencil-square"></i></button>
                  {% endif %}
                  <span>&nbsp;</span>
                  {# Detach button #}
                  <a href="{{ path('audit.evidence.detach_modal_form', {'audit_evidence': evidence.id(), 'audit_question': audit_question_entity.id()}) }}" class="audit-evidence-detach use-ajax" data-dialog-type="modal" data-dialog-options="{&quot;width&quot;:800,&quot;height&quot;:600}"><i class="bi bi-x-circle"></i></a>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {# Display AJAX toggle for yes/no questions if evidence exists or for creating new evidence #}
        {% if audit_question_entity.field_simple_yes_no.value %}
          <div class="yes-no-checkbox-container">
            <div class="toggle-container">
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  class="yes-no-checkbox"
                  {{ yes_no_checked ? 'checked' : '' }}
                  data-question-id="{{ question_id }}"
                  data-audit-id="{{ audit_id }}"
                  onchange="handleYesNoChange(this)"
                >
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">{{ 'Yes' | t }}</span>
            </div>
          </div>
        {% endif %}

        {# Show attach evidence button for all question types #}
          <div class="audit-card-footer">
            {% if evidences is empty %}
              <em style="font-size: 0.9em; color: #6c757d; margin-right: auto; padding-right: 10px;">{{ 'No evidence attached yet. Use the button to attach existing evidence.' | t }}</em>
            {% endif %}
            <a href="{{ path('audit.attach_evidence_modal', {'audit': audit_entity.id(), 'question': audit_question_entity.id()}) }}" class="use-ajax" data-dialog-type="modal" data-dialog-options='{"width":600,"height":500}'>{{ 'Attach existing evidence' | t }}</a>
          </div>

      </div>
    </div>
    {# <div class="audit-card-footer"></div> #}
  </div>
{% endif %}
